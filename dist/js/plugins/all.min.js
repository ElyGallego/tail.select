/*! pytesNET/tail.select v0.6.0-beta | ECMAScript 5 | @copyright pytesNET <info@pytes.net> */
!function(e,t){"function"==typeof define&&define.amd?define(["tail.select"],t):"object"==typeof module&&module.exports?module.exports=t:t(e.tail.select)}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this,function(_){"use strict";var e={ajax:!0,ajaxCallback:null,ajaxOn:"init",ajaxReset:!1,ajaxSearch:!1},t={"init:before":function(){return this.set("ajax",this.get("ajax")&&"function"==typeof this.get("ajaxCallback")),this._ajax=!1,this._ajax_call=!1,!(this._ajax_result=void 0)},"init:after":function(){return this._ajax="init"===this.get("ajaxOn"),!0},open:function(){"open"===this.get("ajaxOn")&&(this._ajax=!0,this.query.apply(this,this._last_query))},"query:before":function(n,r){if(!this.get("ajax")||"finder"===n&&!this.get("ajaxSearch"))return!0;var e="init"===this.get("ajaxOn")?"loading":void 0,t=function(){var e=this.render("ajax-loading",null,[n,r]),t=_.__.create("DIV","dropdown-inner");t.appendChild(e);var i=this._dropdown.querySelector(".dropdown-inner");this._dropdown[(i?"replace":"append")+"Child"](t,i)}.bind(this);if(this._ajax||t(),this._ajax){if(!(void 0===this._ajax_result||this.get("ajaxReset")&&"ajax"!==n))return!0;if(this._ajax_call)return!1;this._ajax_call=!0,function(e){t(),setTimeout(function(){l.call(e,n,r)},0)}.call(this,this)}var i=this.value(),a=this.get("multiLimit",1/0);if(void 0===e){switch(!0){case this.get("disabled"):e="disabled";break;case this.get("multiple")&&a===1/0:e=0===i.length?"multiple":"multipleList";break;case this.get("multiple")&&a!==1/0:e=i.length===a?"multipleLimit":"multipleCount";break;default:e=this.get("multiple")?"multiple":"single"}"disabled"!==e&&(e="string"==typeof this.get("placeholder")?this.get("placeholder"):e)}return this.updateLabel(e).updateCSV(),!1},render:function(e){return e["ajax-loading"]=function(){var e=_.__.create("DIV","dropdown-ajax-loading");return e.innerHTML="<span>"+this._e("loading")+"</span>",e},e["ajax-error"]=function(e){var t=_.__.create("DIV","dropdown-ajax-error");return t.innerHTML="<span>"+(e||this._e("error"))+"</span>",t},[e]}},l=function(r,a){var l=this,e={success:function(e,t){if(void 0!==l._ajax_result&&!t)for(var i in l._ajax_result){var n=l._ajax_result[i];"string"==typeof n||n instanceof HTMLElement?l.options.remove(i,!1):l.options.remove([i,n.group||n.optgroup||"#"],!1)}l._ajax_call=!1,l._ajax_result=e,l.options.add(e,null,!1),l.query.apply(l,["ajax",l._last_query[1]])},error:function(e){l._ajax_call=!1,l._ajax_result=void 0;var t=_.__.create("DIV","dropdown-inner"),i=l.render("ajax-error",e,[r,a]);t.appendChild(i);var n=l._dropdown.querySelector(".dropdown-inner");l._dropdown[(n?"replace":"append")+"Child"](t,n)}};(l.get("ajaxCallback")||function(){this.error("No Walker set")}).call(e,r,a)};_.plugins.add("ajax",e,t),_.strings.en.error="An Error is occured";var e={columns:1,groupCollapse:!(_.strings.en.loading="Loading")},t={"init:after":function(){var e=this.get("columns");return this.set("columns",e<1?1:5<e?5:e),!0},"bind:after":function(e){return this.get("groupCollapse")&&"click"===e.type&&e.target.classList.contains("optgroup-collapse")&&this.collapse(e.target.parentElement.parentElement),!0},"query:after":function(){if(!this.get("groupCollapse"))return!0;for(var e=this._dropdown.querySelectorAll("ul"),t=0;t<e.length;t++)e[t].style.maxHeight=e[t].offsetHeight+"px";return!0},"render#group":function(e){if(this.get("groupCollapse")&&e.querySelector("li.optgroup-title")){var t=_.__.create("SPAN","optgroup-collapse");t.setAttribute("data-collapse","true"),e.querySelector("li.optgroup-title").appendChild(t)}return[e]},dropdown:function(e){if(this.get("columns")<=1)return[e];for(var t=e.querySelectorAll("li"),i=parseInt(this.get("columns")),n=".".repeat(i-1).split(".").map(function(){return _.__.create("DIV","inner-column")}),r=t.length+(i-1),a=-1,l=null,s=0,o=0;o<t.length;s++,o++){var u=Math.max(Math.floor(s/Math.ceil(r/i)),a);if((u=Math.min(u,i-1))!==a||t[o].classList.contains("optgroup-title")||!l){if(!l||t[o].classList.contains("optgroup-title")){var c=t[o].parentElement.getAttribute("data-group"),p=this.e.querySelector("optgroup[label='"+c+"']");l=this.render("group",p,null)}else{var h=l.cloneNode(),c;if(l.querySelector(".optgroup-title b"))(c=l.querySelector(".optgroup-title").cloneNode(!0)).querySelector("b").innerText+=" ("+this._e("continue")+")",h.appendChild(c);l=h,s++}var d=Math.floor((s+1)/Math.ceil(r/i));a=u<d&&d<i?(s++,u=d):u,n[u].appendChild(l)}t[o].classList.contains("optgroup-title")||l.appendChild(t[o])}e.innerHTML="",e.classList.add("dropdown-columns"),e.classList.add("columns-"+this.get("columns"));for(var o=0;o<n.length;o++)e.appendChild(n[o]);return[e]}};_.plugins.add("columns",e,t),_.strings.en.continue="Continue";var e={input:!0,create:!(_.prototype.collapse=function(e){return"string"==typeof e&&(e=this._dropdown.querySelector("ul[data-group='"+e+"']")),e instanceof HTMLElement&&e.classList.toggle("collapsed"),this}),createCallback:null,createHidden:!1,createGroup:"#",createRemove:!1},t={"init:before":function(){return this.get("input")&&this.set("search",!0),!0},"build:after":function(){return this.get("input")&&(this._label.classList.add("label-input"),this._search.querySelector("input").removeAttribute("placeholder"),this._search.className="label-search"),!0},"bind:before":function(e){if(!(e instanceof Event&&this.get("input")))return!0;if("input"!==e.type||e.target!==this._search.children[0])return!0;this.calculateLabelInput();var t=e.target;return t.value.length>=Math.max(this.get("searchMinLength",3),1)?this.query("finder",[t.value,this.get("searchConfig",["text","value"]),this.get("sortSearch")]):this._last_query[0]!==this.options.walker&&this.query("walker",[this.get("sortGroups"),this.get("sortItems")]),t.focus(),!1},"update#label":function(e,t,i,n){if(!this.get("input"))return[e,t,i,n];var r=_.__.create("DIV",this._label.className);if(this.get("multiple")||t!==this.value()?(this._search.children[0].setAttribute("placeholder",this._e(t,n)),this.calculateLabelInput(this._e(t,n))):(this._search.children[0].value=t,this.calculateLabelInput(t)),i){var a=_.__.create("DIV","label-count");a.innerHTML=this._e(i,n),r.appendChild(a)}var l=_.__.create("DIV","label-inner");return l.appendChild(this._search),r.appendChild(l),[r,t,i,n]},"render#empty":function(e){if(!this.get("input")||!this.get("inputCreate"))return[e];var t=_.__.create("SPAN","dropdown-create");return t.innerHTML="<b>"+this._e("createOption")+"</b><span>"+this._search.children[0].value+"</span>",[t]}};_.plugins.add("input",e,t),_.strings.en.createOption="Press Return to create";var e={move:null,moveHide:!(_.prototype.calculateLabelInput=function(e){if(!this.get("input"))return this;var t=_.__.create("SPAN","search-width");return t.innerText=e||this._search.children[0].value,this._label.appendChild(t),this._search.children[0].style.width=Math.max(t.offsetWidth,2)+"px",this._label.removeChild(t),this}),moveOrder:!0,pinSelected:!1},t={"init:before":function(){if(!this.get("multiple",0))return!0;var e=this.get("move");return"string"==typeof e?this._container=document.querySelector(e):e instanceof HTMLElement?this._container=e:!0===e&&(this._container=document.createElement("DIV")),this._container&&this._container.classList.add("tail-select-container"),!0},"bind:before":function(e){if(!this._container||!(e instanceof Event&&this._container.contains(e.target)))return!0;var t,i,n,r=e.target;do{if(!r||r==this._container)return!0;t=r.getAttribute("data-value"),i=r.getAttribute("data-group"),n=r.getAttribute("data-action")}while((!n||!t&&!i)&&null!==(r=r.parentElement));if(n&&(t||i)){var a="toggle"===n?[[t,i],"selected"]:[[t,i]];return this.options[n].apply(this.options,a),!1}return!0},"update:after":function(e,t,i){return this.get("move")&&this.updateContainer(e),this.get("pinSelected")&&this.updatePin(e),!0},"query:after":function(e,t){if("walker"!==e)return!0;if(this.get("moveOrder")&&(this._container_index=[].map.call(this._dropdown.querySelectorAll("li.dropdown-option"),function(e){return e}),this._container_items=".".repeat(this._container_index.length-1).split(".")),this.get("move")||this.get("pinSelected")){for(var i=this.options.get(null,null,!0),n=[],r=0;r<i.length;r++)n.push([i[r],{selected:!0}]);this.get("move")&&this.updateContainer(n),this.get("pinSelected")&&this.updatePin(n)}return!0},render:function(e){return e["move-item"]=function(e){var t=e.parentElement instanceof HTMLOptGroupElement&&e.parentElement.label||"#",i=_.__.create("DIV","select-item"),n=_.__.create("SPAN","item-title"),r=_.__.create("SPAN","item-unselect");return i.setAttribute("data-value",e.value||e.innerText),i.setAttribute("data-group",t),i.setAttribute("data-action","unselect"),n.innerText=e.innerText,i.appendChild(r),i.appendChild(n),i},[e]}};return _.plugins.add("movement",e,t),_.prototype.updateContainer=function(e){if(!this._container)return this;for(var t=0;t<e.length;t++){var i=e[t],n=i[0],r=i[1],a=n.value||n.innerText,l=n.parentElement instanceof HTMLOptGroupElement&&n.parentElement.label||"#",s=this._container.querySelector(".select-item[data-value='"+a+"'][data-group='"+l+"']");if(r.selected&&!s){var o=this.render("move-item",n,null);if(!this.get("moveOrder")){this._container.appendChild(o);continue}for(var u=this._dropdown.querySelector("li[data-value='"+a+"'][data-group='"+l+"']"),c=this._container_index.indexOf(u),p=this._container.querySelector(".select-item")?c:this._container_index.length;p++,this._container_items.length>p&&""===this._container_items[p];);this._container_items[p]?this._container.insertBefore(o,this._container_items[p]):this._container.appendChild(o),this._container_items[c]=o}else if(!r.selected&&s){this._container.removeChild(s);var c=this._container_items.indexOf(s);this.get("moveOrder")&&0<=c&&(this._container_items[c]="")}}return this},_.prototype.updatePin=function(e){if(!this.get("pinSelected"))return this;for(var t=0;t<e.length;t++){var i=e[t],n=i[0],r=i[1],a=n.value||n.innerText,l=n.parentElement instanceof HTMLOptGroupElement&&n.parentElement.label||"#",s=this._dropdown.querySelector("li[data-value='"+a+"'][data-group='"+l+"']");if(r.selected&&!s.classList.contains("pinned")){var o=s.cloneNode(!0),u=s.parentElement;s.classList.add("pinned"),o.style.display="none",u.replaceChild(o,s),u.insertBefore(s,u.querySelector("li:not(.pinned)"))}else if(!r.selected&&s.classList.contains("pinned")){var o=this._dropdown.querySelector("li[data-value='"+a+"'][data-group='"+l+"']:not(.pinned)");s.classList.remove("pinned"),o.parentElement.replaceChild(s,o)}}return this},_});