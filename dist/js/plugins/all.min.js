/*! pytesNET/tail.select v0.6.0-beta | ECMAScript 5 | @copyright pytesNET <info@pytes.net> */
!function(e,t){"function"==typeof define&&define.amd?define(["tail.select"],t):"object"==typeof module&&module.exports?module.exports=t:t(e.tail.select)}("undefined"!=typeof window?window:"undefined"!=typeof global?global:this,function(g){"use strict";var e={ajax:!0,ajaxCallback:null,ajaxOn:"init",ajaxReset:!1,ajaxSearch:!1},t={"init:before":function(){return this.set("ajax",this.get("ajax")&&"function"==typeof this.get("ajaxCallback")),this._ajax=!1,this._ajax_call=!1,!(this._ajax_result=void 0)},"init:after":function(){return this._ajax="init"===this.get("ajaxOn"),!0},open:function(){"open"===this.get("ajaxOn")&&(this._ajax=!0,this.query.apply(this,this._last_query))},"query:before":function(r,a){if(!this.get("ajax")||"finder"===r&&!this.get("ajaxSearch"))return!0;var e="init"===this.get("ajaxOn")?"loading":void 0,t=function(e){var t=this.render("ajax-"+(e?"waiting":"loading"),null,[r,a]),n=g.__.create("DIV","dropdown-inner");n.appendChild(t);var i=this._dropdown.querySelector(".dropdown-inner");this._dropdown[(i?"replace":"append")+"Child"](n,i)}.bind(this);if("input"===this.get("ajaxOn")&&"finder"===r&&(this._ajax=!0),this._ajax||t("input"===this.get("ajaxOn")),this._ajax){if(!(void 0===this._ajax_result||this.get("ajaxReset")&&"ajax"!==r))return!0;if(this._ajax_call)return!1;this._ajax_call=!0,function(e){t(0),setTimeout(function(){l.call(e,r,a)},0)}.call(this,this)}var n=this.value(),i=this.get("multiLimit",1/0);if(void 0===e){switch(!0){case this.get("disabled"):e="disabled";break;case this.get("multiple")&&i===1/0:e=0===n.length?"multiple":"multipleList";break;case this.get("multiple")&&i!==1/0:e=n.length===i?"multipleLimit":"multipleCount";break;default:e=this.get("multiple")?"multiple":"single"}"disabled"!==e&&(e="string"==typeof this.get("placeholder")?this.get("placeholder"):e)}return this.updateLabel(e).updateCSV(),!1},"query:after":function(){return console.log(this._label.querySelector("input")),this._label.querySelector("input").focus(),!0},render:function(e){return e["ajax-waiting"]=function(e){var t=g.__.create("DIV","dropdown-ajax dropdown-ajax-waiting");return t.innerHTML="<span>"+(e||this._e("waiting"))+"</span>",t},e["ajax-loading"]=function(){var e=g.__.create("DIV","dropdown-ajax dropdown-ajax-loading");return e.innerHTML="<span>"+this._e("loading")+"</span>",e},e["ajax-error"]=function(e){var t=g.__.create("DIV","dropdown-ajax dropdown-ajax-error");return t.innerHTML="<span>"+(e||this._e("error"))+"</span>",t},[e]}},l=function(r,a){var l=this,e={success:function(e,t){if(void 0!==l._ajax_result&&!t)for(var n in l._ajax_result){var i=l._ajax_result[n];"string"==typeof i||i instanceof HTMLElement?l.options.remove(n,!0):l.options.remove([n,i.group||i.optgroup||"#"],!0)}l._ajax_call=!1,l._ajax_result=e,l.options.add(e,null,!1),l.query.apply(l,["ajax",l._last_query[1]])},error:function(e){l._ajax_call=!1,l._ajax_result=void 0;var t=g.__.create("DIV","dropdown-inner"),n=l.render("ajax-error",e,[r,a]);t.appendChild(n);var i=l._dropdown.querySelector(".dropdown-inner");l._dropdown[(i?"replace":"append")+"Child"](t,i)}};(l.get("ajaxCallback")||function(){this.error("No Walker set")}).call(e,r,a)};g.plugins.add("ajax",e,t),g.strings.en.error="An Error is occured",g.strings.en.loading="Loading";var e={columns:1,groupCollapse:!(g.strings.en.waiting="Waiting for input")},t={"init:after":function(){var e=this.get("columns");return this.set("columns",e<1?1:5<e?5:e),!0},"bind:after":function(e){return this.get("groupCollapse")&&"click"===e.type&&e.target.classList.contains("optgroup-collapse")&&this.collapse(e.target.parentElement.parentElement),!0},"query:after":function(){if(!this.get("groupCollapse"))return!0;for(var e=this._dropdown.querySelectorAll("ul"),t=0;t<e.length;t++)e[t].style.maxHeight=e[t].offsetHeight+"px";return!0},"render#group":function(e){if(this.get("groupCollapse")&&e.querySelector("li.optgroup-title")){var t=g.__.create("SPAN","optgroup-collapse");t.setAttribute("data-collapse","true"),e.querySelector("li.optgroup-title").appendChild(t)}return[e]},dropdown:function(e){if(this.get("columns")<=1)return[e];for(var t=e.querySelectorAll("li"),n=parseInt(this.get("columns")),i=".".repeat(n-1).split(".").map(function(){return g.__.create("DIV","inner-column")}),r=t.length+(n-1),a=-1,l=null,o=0,s=0;s<t.length;o++,s++){var u=Math.max(Math.floor(o/Math.ceil(r/n)),a);if((u=Math.min(u,n-1))!==a||t[s].classList.contains("optgroup-title")||!l){if(!l||t[s].classList.contains("optgroup-title")){var c=t[s].parentElement.getAttribute("data-group"),p=this.e.querySelector("optgroup[label='"+c+"']");l=this.render("group",p,null)}else{var h=l.cloneNode(),c;if(l.querySelector(".optgroup-title b"))(c=l.querySelector(".optgroup-title").cloneNode(!0)).querySelector("b").innerText+=" ("+this._e("continue")+")",h.appendChild(c);l=h,o++}var d=Math.floor((o+1)/Math.ceil(r/n));a=u<d&&d<n?(o++,u=d):u,i[u].appendChild(l)}t[s].classList.contains("optgroup-title")||l.appendChild(t[s])}e.innerHTML="",e.classList.add("dropdown-columns"),e.classList.add("columns-"+this.get("columns"));for(var s=0;s<i.length;s++)e.appendChild(i[s]);return[e]}};g.plugins.add("columns",e,t),g.strings.en.continue="Continue";var e={input:!0,create:!(g.prototype.collapse=function(e){return"string"==typeof e&&(e=this._dropdown.querySelector("ul[data-group='"+e+"']")),e instanceof HTMLElement&&e.classList.toggle("collapsed"),this}),createCallback:null,createHidden:!1,createGroup:"#",createRemove:!1},t={"init:before":function(){return this.get("input")&&this.set("search",!0),!0},"build:after":function(){return this.get("input")&&(this._label.classList.add("label-input"),this._search.querySelector("input").removeAttribute("placeholder"),this._search.className="label-search"),!0},"bind:before":function(e){if(!(e instanceof Event&&this.get("input")))return!0;if("input"!==e.type||e.target!==this._search.children[0])return!0;this.calculateLabelInput();var t=e.target;return t.value.length>=Math.max(this.get("searchMinLength",3),1)?this.query("finder",[t.value,this.get("searchConfig",["text","value"]),this.get("sortSearch")]):this._last_query[0]!==this.options.walker&&this.query("walker",[this.get("sortGroups"),this.get("sortItems")]),t.focus(),!1},"update#label":function(e,t,n,i){if(!this.get("input"))return[e,t,n,i];var r=g.__.create("DIV",this._label.className);if(this.get("multiple")||t!==this.value()?(this._search.children[0].setAttribute("placeholder",this._e(t,i)),this.calculateLabelInput(this._e(t,i))):(this._search.children[0].value=t,this.calculateLabelInput(t)),n){var a=g.__.create("DIV","label-count");a.innerHTML=this._e(n,i),r.appendChild(a)}var l=g.__.create("DIV","label-inner");return l.appendChild(this._search),r.appendChild(l),[r,t,n,i]},"render#empty":function(e){if(!this.get("input")||!this.get("inputCreate"))return[e];var t=g.__.create("SPAN","dropdown-create");return t.innerHTML="<b>"+this._e("createOption")+"</b><span>"+this._search.children[0].value+"</span>",[t]}};g.plugins.add("input",e,t),g.strings.en.createOption="Press Return to create";var e={move:null,moveHide:!(g.prototype.calculateLabelInput=function(e){if(!this.get("input"))return this;var t=g.__.create("SPAN","search-width");return t.innerText=e||this._search.children[0].value,this._label.appendChild(t),this._search.children[0].style.width=Math.max(t.offsetWidth,2)+"px",this._label.removeChild(t),this}),moveOrder:!0,pinSelected:!1},t={"init:before":function(){if(!this.get("multiple",0))return!0;var e=this.get("move");return"string"==typeof e?this._container=document.querySelector(e):e instanceof HTMLElement?this._container=e:!0===e&&(this._container=document.createElement("DIV")),this._container&&this._container.classList.add("tail-select-container"),!0},"bind:before":function(e){if(!this._container||!(e instanceof Event&&this._container.contains(e.target)))return!0;var t,n,i,r=e.target;do{if(!r||r==this._container)return!0;t=r.getAttribute("data-value"),n=r.getAttribute("data-group"),i=r.getAttribute("data-action")}while((!i||!t&&!n)&&null!==(r=r.parentElement));if(i&&(t||n)){var a="toggle"===i?[[t,n],"selected"]:[[t,n]];return this.options[i].apply(this.options,a),!1}return!0},"update:after":function(e,t,n){return this.get("move")&&this.updateContainer(e),this.get("pinSelected")&&this.updatePin(e),!0},"query:after":function(e,t){if("walker"!==e)return!0;if(this.get("moveOrder")&&(this._container_index=[].map.call(this._dropdown.querySelectorAll("li.dropdown-option"),function(e){return e}),this._container_items=".".repeat(this._container_index.length-1).split(".")),this.get("move")||this.get("pinSelected")){for(var n=this.options.get(null,null,!0),i=[],r=0;r<n.length;r++)i.push([n[r],{selected:!0}]);this.get("move")&&this.updateContainer(i),this.get("pinSelected")&&this.updatePin(i)}return!0},render:function(e){return e["move-item"]=function(e){var t=e.parentElement instanceof HTMLOptGroupElement&&e.parentElement.label||"#",n=g.__.create("DIV","select-item"),i=g.__.create("SPAN","item-title"),r=g.__.create("SPAN","item-unselect");return n.setAttribute("data-value",e.value||e.innerText),n.setAttribute("data-group",t),n.setAttribute("data-action","unselect"),i.innerText=e.innerText,n.appendChild(r),n.appendChild(i),n},[e]}};return g.plugins.add("movement",e,t),g.prototype.updateContainer=function(e){if(!this._container)return this;for(var t=0;t<e.length;t++){var n=e[t],i=n[0],r=n[1],a=i.value||i.innerText,l=i.parentElement instanceof HTMLOptGroupElement&&i.parentElement.label||"#",o=this._container.querySelector(".select-item[data-value='"+a+"'][data-group='"+l+"']");if(r.selected&&!o){var s=this.render("move-item",i,null);if(!this.get("moveOrder")){this._container.appendChild(s);continue}for(var u=this._dropdown.querySelector("li[data-value='"+a+"'][data-group='"+l+"']"),c=this._container_index.indexOf(u),p=this._container.querySelector(".select-item")?c:this._container_index.length;p++,this._container_items.length>p&&""===this._container_items[p];);this._container_items[p]?this._container.insertBefore(s,this._container_items[p]):this._container.appendChild(s),this._container_items[c]=s}else if(!r.selected&&o){this._container.removeChild(o);var c=this._container_items.indexOf(o);this.get("moveOrder")&&0<=c&&(this._container_items[c]="")}}return this},g.prototype.updatePin=function(e){if(!this.get("pinSelected"))return this;for(var t=0;t<e.length;t++){var n=e[t],i=n[0],r=n[1],a=i.value||i.innerText,l=i.parentElement instanceof HTMLOptGroupElement&&i.parentElement.label||"#",o=this._dropdown.querySelector("li[data-value='"+a+"'][data-group='"+l+"']");if(r.selected&&!o.classList.contains("pinned")){var s=o.cloneNode(!0),u=o.parentElement;o.classList.add("pinned"),s.style.display="none",u.replaceChild(s,o),u.insertBefore(o,u.querySelector("li:not(.pinned)"))}else if(!r.selected&&o.classList.contains("pinned")){var s=this._dropdown.querySelector("li[data-value='"+a+"'][data-group='"+l+"']:not(.pinned)");o.classList.remove("pinned"),s.parentElement.replaceChild(o,s)}}return this},g});