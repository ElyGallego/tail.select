/*! pytesNET/tail.select v{{ $data.version }}-beta | {{ $build }} | @copyright pytesNET <info@pytes.net> */
export function plugin(e){"use strict";var t={ajax:!0,ajaxCallback:null,ajaxOn:"init",ajaxReset:!1,ajaxSearch:!1},i={"init:before":function(){return this.set("ajax",this.get("ajax")&&"function"==typeof this.get("ajaxCallback")),this._ajax=!1,this._ajax_call=!1,this._ajax_result=void 0,!0},"init:after":function(){return this._ajax="init"===this.get("ajaxOn"),!0},open:function(){"open"===this.get("ajaxOn")&&(this._ajax=!0,this.query.apply(this,this._last_query))},"query:before":function(t,i){if(!this.get("ajax")||"finder"===t&&!this.get("ajaxSearch"))return!0;let r="init"===this.get("ajaxOn")?"loading":void 0,a=function(){let n=this.render("ajax-loading",null,[t,i]),r=e.__.create("DIV","dropdown-inner");r.appendChild(n);let a=this._dropdown.querySelector(".dropdown-inner");this._dropdown[(a?"replace":"append")+"Child"](r,a)}.bind(this);if(this._ajax||a(),this._ajax){if(!(void 0===this._ajax_result||this.get("ajaxReset")&&"ajax"!==t))return!0;if(this._ajax_call)return!1;this._ajax_call=!0,function(e){a(),setTimeout(function(){n.call(e,t,i)},0)}.call(this,this)}let l=this.value(),s=this.get("multiLimit",1/0);if(void 0===r){switch(!0){case this.get("disabled"):r="disabled";break;case this.get("multiple")&&s===1/0:r=0===l.length?"multiple":"multipleList";break;case this.get("multiple")&&s!==1/0:r=l.length===s?"multipleLimit":"multipleCount";break;default:r=this.get("multiple")?"multiple":"single"}"disabled"!==r&&(r="string"==typeof this.get("placeholder")?this.get("placeholder"):r)}return this.updateLabel(r).updateCSV(),!1},render:function(t){return t["ajax-loading"]=function(){let t=e.__.create("DIV","dropdown-ajax-loading");return t.innerHTML=`<span>${this._e("loading")}</span>`,t},t["ajax-error"]=function(t){let i=e.__.create("DIV","dropdown-ajax-error");return i.innerHTML=`<span>${t||this._e("error")}</span>`,i},[t]}};let n=function(t,i){let n=this,r={success:function(e,t){if(void 0!==n._ajax_result&&!t)for(let e in n._ajax_result){let t=n._ajax_result[e];"string"==typeof t||t instanceof HTMLElement?n.options.remove(e,!1):n.options.remove([e,t.group||t.optgroup||"#"],!1)}n._ajax_call=!1,n._ajax_result=e,n.options.add(e,null,!1),n.query.apply(n,["ajax",n._last_query[1]])},error:function(r){n._ajax_call=!1,n._ajax_result=void 0;let a=e.__.create("DIV","dropdown-inner"),l=n.render("ajax-error",r,[t,i]);a.appendChild(l);let s=n._dropdown.querySelector(".dropdown-inner");n._dropdown[(s?"replace":"append")+"Child"](a,s)}};(n.get("ajaxCallback")||function(){this.error("No Walker set")}).call(r,t,i)};e.plugins.add("ajax",t,i),e.strings.en.error="An Error is occured",e.strings.en.loading="Loading";var t={columns:1,groupCollapse:!1},i={"init:after":function(){let e=this.get("columns");return this.set("columns",e<1?1:e>5?5:e),!0},"bind:after":function(e){return!this.get("groupCollapse")||("click"===e.type&&e.target.classList.contains("optgroup-collapse")&&this.collapse(e.target.parentElement.parentElement),!0)},"query:after":function(){if(!this.get("groupCollapse"))return!0;let e=this._dropdown.querySelectorAll("ul");for(var t=0;t<e.length;t++)e[t].style.maxHeight=e[t].offsetHeight+"px";return!0},"render#group":function(t){if(this.get("groupCollapse")&&t.querySelector("li.optgroup-title")){let i=e.__.create("SPAN","optgroup-collapse");i.setAttribute("data-collapse","true"),t.querySelector("li.optgroup-title").appendChild(i)}return[t]},dropdown:function(t){if(this.get("columns")<=1)return[t];let i=t.querySelectorAll("li"),n=parseInt(this.get("columns")),r=".".repeat(n-1).split(".").map(()=>e.__.create("DIV","inner-column")),a=i.length+(n-1),l=-1,s=null;for(let e=0,t=0;t<i.length;e++,t++){let o=Math.max(Math.floor(e/Math.ceil(a/n)),l);if((o=Math.min(o,n-1))!==l||i[t].classList.contains("optgroup-title")||!s){if(!s||i[t].classList.contains("optgroup-title")){let e=i[t].parentElement.getAttribute("data-group"),n=this.e.querySelector(`optgroup[label='${e}']`);s=this.render("group",n,null)}else{let t=s.cloneNode();if(s.querySelector(".optgroup-title b")){let e=s.querySelector(".optgroup-title").cloneNode(!0);e.querySelector("b").innerText+=` (${this._e("continue")})`,t.appendChild(e)}s=t,e++}let u=Math.floor((e+1)/Math.ceil(a/n));u>o&&u<n?(e++,l=o=u):l=o,r[o].appendChild(s)}i[t].classList.contains("optgroup-title")||s.appendChild(i[t])}t.innerHTML="",t.classList.add("dropdown-columns"),t.classList.add("columns-"+this.get("columns"));for(let e=0;e<r.length;e++)t.appendChild(r[e]);return[t]}};e.plugins.add("columns",t,i),e.strings.en.continue="Continue",e.prototype.collapse=function(e){return"string"==typeof e&&(e=this._dropdown.querySelector(`ul[data-group='${e}']`)),e instanceof HTMLElement&&e.classList.toggle("collapsed"),this};var t={input:!0,create:!1,createCallback:null,createHidden:!1,createGroup:"#",createRemove:!1},i={"init:before":function(){return this.get("input")&&this.set("search",!0),!0},"build:after":function(){return this.get("input")&&(this._label.classList.add("label-input"),this._search.querySelector("input").removeAttribute("placeholder"),this._search.className="label-search"),!0},"bind:before":function(e){if(!(e instanceof Event&&this.get("input")))return!0;if("input"!==e.type||e.target!==this._search.children[0])return!0;this.calculateLabelInput();let t=e.target;return t.value.length>=Math.max(this.get("searchMinLength",3),1)?this.query("finder",[t.value,this.get("searchConfig",["text","value"]),this.get("sortSearch")]):this._last_query[0]!==this.options.walker&&this.query("walker",[this.get("sortGroups"),this.get("sortItems")]),t.focus(),!1},"update#label":function(t,i,n,r){if(!this.get("input"))return[t,i,n,r];let a=e.__.create("DIV",this._label.className);if(this.get("multiple")||i!==this.value()?(this._search.children[0].setAttribute("placeholder",this._e(i,r)),this.calculateLabelInput(this._e(i,r))):(this._search.children[0].value=i,this.calculateLabelInput(i)),n){let t=e.__.create("DIV","label-count");t.innerHTML=this._e(n,r),a.appendChild(t)}let l=e.__.create("DIV","label-inner");return l.appendChild(this._search),a.appendChild(l),[a,i,n,r]},"render#empty":function(t){if(!this.get("input")||!this.get("inputCreate"))return[t];let i=e.__.create("SPAN","dropdown-create");return i.innerHTML=`<b>${this._e("createOption")}</b>`+`<span>${this._search.children[0].value}</span>`,[i]}};e.plugins.add("input",t,i),e.strings.en.createOption="Press Return to create",e.prototype.calculateLabelInput=function(t){if(!this.get("input"))return this;let i=e.__.create("SPAN","search-width");return i.innerText=t||this._search.children[0].value,this._label.appendChild(i),this._search.children[0].style.width=Math.max(i.offsetWidth,2)+"px",this._label.removeChild(i),this};var t={move:null,moveHide:!1,moveOrder:!0,pinSelected:!1},i={"init:before":function(){if(!this.get("multiple",0))return!0;let e=this.get("move");return"string"==typeof e?this._container=document.querySelector(e):e instanceof HTMLElement?this._container=e:!0===e&&(this._container=document.createElement("DIV")),this._container&&this._container.classList.add("tail-select-container"),!0},"bind:before":function(e){if(!this._container||!(e instanceof Event&&this._container.contains(e.target)))return!0;let t,i,n,r=e.target;do{if(!r||r==this._container)return!0;t=r.getAttribute("data-value"),i=r.getAttribute("data-group"),n=r.getAttribute("data-action")}while((!n||!t&&!i)&&null!==(r=r.parentElement));if(n&&(t||i)){let e="toggle"===n?[[t,i],"selected"]:[[t,i]];return this.options[n].apply(this.options,e),!1}return!0},"update:after":function(e,t,i){return this.get("move")&&this.updateContainer(e),this.get("pinSelected")&&this.updatePin(e),!0},"query:after":function(e,t){if("walker"!==e)return!0;if(this.get("moveOrder")&&(this._container_index=[].map.call(this._dropdown.querySelectorAll("li.dropdown-option"),e=>e),this._container_items=".".repeat(this._container_index.length-1).split(".")),this.get("move")||this.get("pinSelected")){let e=this.options.get(null,null,!0),t=[];for(let i=0;i<e.length;i++)t.push([e[i],{selected:!0}]);this.get("move")&&this.updateContainer(t),this.get("pinSelected")&&this.updatePin(t)}return!0},render:function(t){return t["move-item"]=function(t){let i=t.parentElement instanceof HTMLOptGroupElement&&t.parentElement.label||"#",n=e.__.create("DIV","select-item"),r=e.__.create("SPAN","item-title"),a=e.__.create("SPAN","item-unselect");return n.setAttribute("data-value",t.value||t.innerText),n.setAttribute("data-group",i),n.setAttribute("data-action","unselect"),r.innerText=t.innerText,n.appendChild(a),n.appendChild(r),n},[t]}};return e.plugins.add("movement",t,i),e.prototype.updateContainer=function(e){if(!this._container)return this;for(let t=0;t<e.length;t++){let[i,n]=e[t],r=i.value||i.innerText,a=i.parentElement instanceof HTMLOptGroupElement&&i.parentElement.label||"#",l=this._container.querySelector(`.select-item[data-value='${r}'][data-group='${a}']`);if(n.selected&&!l){let e=this.render("move-item",i,null);if(!this.get("moveOrder")){this._container.appendChild(e);continue}let t=this._dropdown.querySelector(`li[data-value='${r}'][data-group='${a}']`),n=this._container_index.indexOf(t),l=this._container.querySelector(".select-item")?n:this._container_index.length;do{l++}while(this._container_items.length>l&&""===this._container_items[l]);this._container_items[l]?this._container.insertBefore(e,this._container_items[l]):this._container.appendChild(e),this._container_items[n]=e}else if(!n.selected&&l){this._container.removeChild(l);let e=this._container_items.indexOf(l);this.get("moveOrder")&&e>=0&&(this._container_items[e]="")}}return this},e.prototype.updatePin=function(e){if(!this.get("pinSelected"))return this;for(let t=0;t<e.length;t++){let[i,n]=e[t],r=i.value||i.innerText,a=i.parentElement instanceof HTMLOptGroupElement&&i.parentElement.label||"#",l=this._dropdown.querySelector(`li[data-value='${r}'][data-group='${a}']`);if(n.selected&&!l.classList.contains("pinned")){let e=l.cloneNode(!0),t=l.parentElement;l.classList.add("pinned"),e.style.display="none",t.replaceChild(e,l),t.insertBefore(l,t.querySelector("li:not(.pinned)"))}else if(!n.selected&&l.classList.contains("pinned")){let e=this._dropdown.querySelector(`li[data-value='${r}'][data-group='${a}']:not(.pinned)`);l.classList.remove("pinned"),e.parentElement.replaceChild(l,e)}}return this},e};